# Lab 2

## Objectives

Manage access to SQL Server instances & the performance and availability of databases. We will also work with Integration Services and Analysis Services components. To benefit fully from these exercises, take the time to examine the PowerShell scripts used. They will prove useful if you decide to do the optional lab.

## Exercise 1

We will create Windows & SQL Login accounts using SQL Server Management Objects (SMO).

> 90 minitues

### Task 1

1. Login to **MIA-SQL** with the **AdventureWorks\Student** account

2. Start **Azure Data Studio** by right clicking and selecting **Run As Administrator**

> We will be using SMO components to create and assign permissions to login and user accounts. :

3. Load the SMO assembly.

> PowerShell 5.1 and newer version use this instead

```powershell
using namespace Microsoft.SqlServer.Management.Smo
```

> Older Version PowerShell

```powershell
[System.Reflection.Assembly]::LoadWithPartialname('Microsoft.SQLServer.SMO')
```

4. Create a variable named **$Instance** to refer to the name of the **MIA-SQL** server:

```powershell
$Instance = "MIA-SQL"
```

5. Create a variable to be used for the **AdventureWorks\User1** user account:

```powershell
$User1 = "AdventureWorks\User1"
```

6. Use SMO components to connect to the **MIA-SQL** instance using the $Server variable: 

> Older Version PowerShell

```powershell
$Server = new-object Microsoft.SqlServer.Management.Smo.Server $Instance
```

> New Version PowerShell, Use This Style

```powershell
$Server = [Server]::new($Instance)
```

7. Use the $Server variable to create a new database:

```powershell
$Server.ConnectionContext.ExecuteWithResults("CREATE DATABASE AWDB")
```

8. Open SQL Server Management Studio with **Run as different user**

9. Type **AdventureWorks\User1** and Press Tab.

10. Type the user pasword and press Enter: **Pa55w.rd**

> Important : If you dont have **User1** test account in your Active Directory use this script to create

```powershell
Enter-PSSession "MIA-DC"
Import-Module -Name "ActiveDirectory"
$User = @{
    Name              = "User1"
    GivenName         = "Test"
    Surname           = "User"
    SamAccountName    = "User1"
    UserPrincipalName = "user1@adventureworks.msft"
    Enabled           = $true
}
New-ADUser @User -AccountPassword(ConvertTo-SecureString -AsPlainText 'Pa55w.rd' -Force)
Exit-PSSession
```

11. Verify that **AdventureWorks\User1** **cannot** connect to MIA-SQL

12. Define a Login object to be used for the AdventureWorks\User1 account: 

> Older Version PowerShell

```powershell
$Login = New-Object -TypeName Microsoft.SQLServer.Management.SMO.Login -ArgumentList $Instance,$User1
```

> New Version PowerShell, Use This Style

```powershell
$Login = [Login]::new($Instance,$User1)
```